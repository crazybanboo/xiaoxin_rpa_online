# å°æ–°RPAåç«¯å•å…ƒæµ‹è¯•æ–‡æ¡£

æœ¬æ–‡æ¡£æè¿°äº†å°æ–°RPAåœ¨çº¿å¹³å°åç«¯çš„æµ‹è¯•æ¶æ„ã€é…ç½®å’Œä½¿ç”¨æ–¹æ³•ã€‚

## ğŸ“ æµ‹è¯•ç»“æ„

```
tests/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ conftest.py              # pytesté…ç½®å’Œå…±äº«fixture
â”œâ”€â”€ utils.py                 # æµ‹è¯•å·¥å…·å’Œè¾…åŠ©å‡½æ•°
â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_models.py       # æ•°æ®æ¨¡å‹æµ‹è¯•
â”‚   â”œâ”€â”€ test_crud.py         # CRUDæ“ä½œæµ‹è¯•
â”‚   â”œâ”€â”€ test_api.py          # APIç«¯ç‚¹æµ‹è¯•
â”‚   â””â”€â”€ test_schemas.py      # Pydantic Schemaæµ‹è¯•
â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_api_integration.py
â”‚   â””â”€â”€ test_database_integration.py
â””â”€â”€ fixtures/                # æµ‹è¯•å¤¹å…·å’Œæ•°æ®
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ database.py          # æ•°æ®åº“ç›¸å…³fixture
    â””â”€â”€ sample_data.py       # ç¤ºä¾‹æµ‹è¯•æ•°æ®
```

## ğŸ› ï¸ æµ‹è¯•é…ç½®

### pytest.ini
ä¸»è¦é…ç½®åŒ…æ‹¬ï¼š
- æµ‹è¯•ç›®å½•ï¼š`tests/`
- è¦†ç›–ç‡æŠ¥å‘Šï¼šHTMLå’Œç»ˆç«¯è¾“å‡º
- è¦†ç›–ç‡é˜ˆå€¼ï¼š80%
- æµ‹è¯•æ ‡è®°ï¼šunit, integration, slow, crud, api, models, schemas

### æµ‹è¯•æ•°æ®åº“
- ä½¿ç”¨SQLiteå†…å­˜æ•°æ®åº“è¿›è¡Œæµ‹è¯•
- æ¯ä¸ªæµ‹è¯•å‡½æ•°ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“ä¼šè¯
- è‡ªåŠ¨åˆ›å»ºå’Œæ¸…ç†æµ‹è¯•è¡¨ç»“æ„

## ğŸš€ è¿è¡Œæµ‹è¯•

### ä½¿ç”¨æµ‹è¯•è¿è¡Œè„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./run_tests.sh

# è¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•
./run_tests.sh unit          # å•å…ƒæµ‹è¯•
./run_tests.sh integration   # é›†æˆæµ‹è¯•
./run_tests.sh models        # æ¨¡å‹æµ‹è¯•
./run_tests.sh crud          # CRUDæµ‹è¯•
./run_tests.sh api           # APIæµ‹è¯•
./run_tests.sh schemas       # Schemaæµ‹è¯•

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
./run_tests.sh coverage

# å¿«é€Ÿæµ‹è¯•ï¼ˆæ— è¦†ç›–ç‡ï¼‰
./run_tests.sh quick

# æ˜¾ç¤ºå¸®åŠ©
./run_tests.sh help
```

### ä½¿ç”¨Pythonæµ‹è¯•è¿è¡Œå™¨

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .env/bin/activate

# ä½¿ç”¨è‡ªå®šä¹‰æµ‹è¯•è¿è¡Œå™¨
python test_runner.py all
python test_runner.py unit
python test_runner.py coverage
python test_runner.py parallel
```

### ç›´æ¥ä½¿ç”¨pytest

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .env/bin/activate

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/unit/ -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest tests/unit/test_models.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
pytest tests/unit/test_models.py::TestAdminModel -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
pytest tests/unit/test_models.py::TestAdminModel::test_admin_creation -v

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=app --cov-report=html

# å¹¶è¡Œè¿è¡Œæµ‹è¯•
pytest -n auto

# åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•
pytest --lf
```

## ğŸ“Š æµ‹è¯•è¦†ç›–

### å½“å‰æµ‹è¯•è¦†ç›–çš„åŠŸèƒ½

#### 1. **æ¨¡å‹æµ‹è¯• (test_models.py)**
- âœ… ç®¡ç†å‘˜æ¨¡å‹ (Admin)
  - åˆ›å»ºã€å”¯ä¸€æ€§çº¦æŸã€å­—ç¬¦ä¸²è¡¨ç¤º
  - ç”¨æˆ·åå’Œé‚®ç®±å”¯ä¸€æ€§æµ‹è¯•
- âœ… å®¢æˆ·ç«¯æ¨¡å‹ (Client)  
  - åˆ›å»ºã€é»˜è®¤å€¼ã€å­—ç¬¦ä¸²è¡¨ç¤º
- âœ… å‡çº§åŒ…æ¨¡å‹ (UpgradePackage)
  - åˆ›å»ºã€å­—ç¬¦ä¸²è¡¨ç¤º
- âœ… å‡çº§ä»»åŠ¡æ¨¡å‹ (UpgradeTask)
  - åˆ›å»ºã€å…³è”å…³ç³»ã€å­—ç¬¦ä¸²è¡¨ç¤º
- âœ… æ—¶é—´æˆ³Mixin
  - è‡ªåŠ¨åˆ›å»ºå’Œæ›´æ–°æ—¶é—´æˆ³

#### 2. **CRUDæ“ä½œæµ‹è¯• (test_crud.py)**
- âœ… ç®¡ç†å‘˜CRUD
  - åˆ›å»ºï¼ˆå¸¦å¯†ç åŠ å¯†ï¼‰ã€æŸ¥è¯¢ã€è®¤è¯ã€æ›´æ–°ã€åˆ é™¤
- âœ… å®¢æˆ·ç«¯CRUD
  - åˆ›å»ºã€IPæŸ¥è¯¢ã€åœ¨çº¿å®¢æˆ·ç«¯æŸ¥è¯¢ã€å¿ƒè·³æ›´æ–°
- âœ… å‡çº§åŒ…CRUD
  - åˆ›å»ºã€ç‰ˆæœ¬æŸ¥è¯¢ã€è·å–æœ€æ–°ç‰ˆæœ¬
- âœ… å‡çº§ä»»åŠ¡CRUD
  - åˆ›å»ºã€å®¢æˆ·ç«¯æŸ¥è¯¢ã€çŠ¶æ€æŸ¥è¯¢ã€ä»»åŠ¡å®Œæˆ

#### 3. **APIç«¯ç‚¹æµ‹è¯• (test_api.py)**
- âœ… ä¸»è¦ç«¯ç‚¹
  - æ ¹è·¯å¾„ã€å¥åº·æ£€æŸ¥
- âœ… API v1ç«¯ç‚¹
  - v1æ ¹è·¯å¾„ã€æµ‹è¯•ç«¯ç‚¹
- âœ… é”™è¯¯å¤„ç†
  - 404ã€405é”™è¯¯

#### 4. **SchemaéªŒè¯æµ‹è¯• (test_schemas.py)**
- âœ… ç®¡ç†å‘˜Schema
  - åˆ›å»ºã€æ›´æ–°ã€å“åº”SchemaéªŒè¯
  - é‚®ç®±æ ¼å¼éªŒè¯ã€å¿…å¡«å­—æ®µéªŒè¯
- âœ… å®¢æˆ·ç«¯Schema
  - åˆ›å»ºã€æ›´æ–°ã€å“åº”SchemaéªŒè¯
- âœ… å‡çº§åŒ…Schema
  - åˆ›å»ºã€æ›´æ–°ã€å“åº”SchemaéªŒè¯
- âœ… å‡çº§ä»»åŠ¡Schema
  - åˆ›å»ºã€æ›´æ–°ã€å“åº”SchemaéªŒè¯

#### 5. **é›†æˆæµ‹è¯• (test_*_integration.py)**
- âœ… APIé›†æˆæµ‹è¯•
  - å¸¦æ•°æ®åº“çš„ç«¯ç‚¹æµ‹è¯•
- âœ… æ•°æ®åº“é›†æˆæµ‹è¯•
  - å®Œæ•´å·¥ä½œæµæµ‹è¯•ã€çº§è”åˆ é™¤ã€å¹¶å‘æ“ä½œ

## ğŸ”§ æµ‹è¯•å·¥å…·å’ŒFixture

### å…±äº«Fixture (conftest.py)
- `db_session`: æµ‹è¯•æ•°æ®åº“ä¼šè¯
- `client`: FastAPIæµ‹è¯•å®¢æˆ·ç«¯
- `sample_*_data`: å„ç§ç¤ºä¾‹æ•°æ®

### æµ‹è¯•å·¥å…· (utils.py)
- `generate_random_*`: éšæœºæ•°æ®ç”Ÿæˆå™¨
- `create_test_*`: æµ‹è¯•æ•°æ®åˆ›å»ºåŠ©æ‰‹
- `assert_*`: è‡ªå®šä¹‰æ–­è¨€åŠ©æ‰‹
- `DatabaseTestCase`: æ•°æ®åº“æµ‹è¯•åŸºç±»

### ç¤ºä¾‹æ•°æ® (fixtures/sample_data.py)
- å„ç§æ¨¡å‹çš„ç¤ºä¾‹æ•°æ®fixture
- æ‰¹é‡æµ‹è¯•æ•°æ®åˆ›å»ºfixture
- å¤æ‚å…³è”å…³ç³»æµ‹è¯•æ•°æ®

## ğŸ“ˆ æµ‹è¯•æŒ‡æ ‡

### è¦†ç›–ç‡ç›®æ ‡
- **æœ€ä½è¦†ç›–ç‡**: 80%
- **ç›®æ ‡è¦†ç›–ç‡**: 90%+

### æ€§èƒ½æŒ‡æ ‡
- å•ä¸ªæµ‹è¯•æ‰§è¡Œæ—¶é—´ < 1ç§’
- å®Œæ•´æµ‹è¯•å¥—ä»¶æ‰§è¡Œæ—¶é—´ < 30ç§’
- å¹¶è¡Œæµ‹è¯•å¯è¿›ä¸€æ­¥å‡å°‘æ‰§è¡Œæ—¶é—´

## ğŸ› è°ƒè¯•æµ‹è¯•

### è°ƒè¯•å•ä¸ªæµ‹è¯•
```bash
# ä½¿ç”¨PDBè°ƒè¯•
pytest tests/unit/test_models.py::TestAdminModel::test_admin_creation -s --pdb

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
pytest tests/unit/test_models.py::TestAdminModel::test_admin_creation -v -s

# åœåœ¨ç¬¬ä¸€ä¸ªå¤±è´¥
pytest -x

# æ˜¾ç¤ºæœ€æ…¢çš„10ä¸ªæµ‹è¯•
pytest --durations=10
```

### å¸¸è§é—®é¢˜è§£å†³

1. **æ•°æ®åº“è¿æ¥é—®é¢˜**
   - ç¡®ä¿æµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“
   - æ£€æŸ¥fixtureçš„æ•°æ®åº“æ¸…ç†é€»è¾‘

2. **å¯¼å…¥é”™è¯¯**
   - ç¡®ä¿PYTHONPATHæ­£ç¡®è®¾ç½®
   - æ£€æŸ¥ç›¸å¯¹å¯¼å…¥è·¯å¾„

3. **å¼‚æ­¥æµ‹è¯•é—®é¢˜**
   - ä½¿ç”¨pytest-asyncioæ’ä»¶
   - ç¡®ä¿async/awaitè¯­æ³•æ­£ç¡®

## ğŸ”„ æŒç»­é›†æˆ

### GitHub Actionsé…ç½®ç¤ºä¾‹
```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.12
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      - name: Run tests
        run: |
          ./run_tests.sh coverage
      - name: Upload coverage
        uses: codecov/codecov-action@v1
```

## ğŸ“ ç¼–å†™æ–°æµ‹è¯•

### æµ‹è¯•å‘½åçº¦å®š
- æµ‹è¯•æ–‡ä»¶ï¼š`test_*.py`
- æµ‹è¯•ç±»ï¼š`Test*`
- æµ‹è¯•æ–¹æ³•ï¼š`test_*`

### æµ‹è¯•ç»“æ„æ¨¡æ¿
```python
import pytest
from app.models.your_model import YourModel

@pytest.mark.unit
class TestYourModel:
    """Test cases for YourModel"""

    def test_create_your_model(self, db_session):
        """Test creating YourModel"""
        # Arrange
        data = {"field": "value"}
        
        # Act
        instance = YourModel(**data)
        db_session.add(instance)
        db_session.commit()
        
        # Assert
        assert instance.field == "value"
        assert instance.id is not None
```

### æœ€ä½³å®è·µ
1. **AAAæ¨¡å¼**: Arrange-Act-Assert
2. **ç‹¬ç«‹æ€§**: æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹è¿è¡Œ
3. **å‘½å**: æµ‹è¯•åç§°åº”è¯¥æ¸…æ™°æè¿°æµ‹è¯•å†…å®¹
4. **æ–‡æ¡£**: ä½¿ç”¨docstringæè¿°æµ‹è¯•ç›®çš„
5. **æ•°æ®**: ä½¿ç”¨fixtureæä¾›æµ‹è¯•æ•°æ®
6. **æ ‡è®°**: ä½¿ç”¨pytest.markè¿›è¡Œæµ‹è¯•åˆ†ç±»

## ğŸ¯ æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•éš”ç¦»
- æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“äº‹åŠ¡
- é¿å…æµ‹è¯•é—´çš„æ•°æ®ä¾èµ–
- ä½¿ç”¨fixtureæä¾›å¹²å‡€çš„æµ‹è¯•ç¯å¢ƒ

### 2. æµ‹è¯•æ•°æ®
- ä½¿ç”¨æœ‰æ„ä¹‰çš„æµ‹è¯•æ•°æ®
- é¿å…ç¡¬ç¼–ç å€¼ï¼Œä½¿ç”¨fixture
- æµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ

### 3. æ–­è¨€
- ä½¿ç”¨å…·ä½“çš„æ–­è¨€è€Œä¸æ˜¯é€šç”¨çš„assertTrue
- æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯
- æµ‹è¯•é¢„æœŸçš„è¡Œä¸ºè€Œä¸æ˜¯å®ç°ç»†èŠ‚

### 4. æ€§èƒ½
- ä¿æŒæµ‹è¯•å¿«é€Ÿæ‰§è¡Œ
- ä½¿ç”¨å†…å­˜æ•°æ®åº“è¿›è¡Œå•å…ƒæµ‹è¯•
- åˆç†ä½¿ç”¨å¹¶è¡Œæµ‹è¯•

## ğŸ›¡ï¸ æµ‹è¯•å®‰å…¨

### æ•æ„Ÿæ•°æ®å¤„ç†
- ä¸åœ¨æµ‹è¯•ä¸­ä½¿ç”¨çœŸå®çš„ç”Ÿäº§æ•°æ®
- ä½¿ç”¨æ¨¡æ‹Ÿå¯¹è±¡è¿›è¡Œå¤–éƒ¨APIè°ƒç”¨
- ç¡®ä¿æµ‹è¯•æ•°æ®ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯

### ç¯å¢ƒéš”ç¦»
- æµ‹è¯•ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒå®Œå…¨éš”ç¦»
- ä½¿ç”¨ç¯å¢ƒå˜é‡åŒºåˆ†æµ‹è¯•å’Œç”Ÿäº§é…ç½®
- è‡ªåŠ¨æ¸…ç†æµ‹è¯•äº§ç”Ÿçš„æ–‡ä»¶å’Œæ•°æ®

---

é€šè¿‡å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼Œæˆ‘ä»¬ç¡®ä¿äº†å°æ–°RPAåœ¨çº¿å¹³å°åç«¯çš„è´¨é‡å’Œç¨³å®šæ€§ã€‚æµ‹è¯•ä¸ä»…éªŒè¯äº†åŠŸèƒ½çš„æ­£ç¡®æ€§ï¼Œè¿˜ä¸ºé‡æ„å’Œæ–°åŠŸèƒ½å¼€å‘æä¾›äº†å®‰å…¨ä¿éšœã€‚